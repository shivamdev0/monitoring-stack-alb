server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /var/lib/promtail/positions.yaml

clients:
  - url: {{ loki_url | default('http://localhost:3100/loki/api/v1/push') }}

scrape_configs:
  - job_name: apache_access
    static_configs:
      - targets: [ "localhost" ]
        labels:
          job: apache_access
          app: {{ promtail_common_labels.app | default('webapp') | to_json }}
          env: {{ promtail_common_labels.env | default('prod') | to_json }}
          __path__: {{ apache_access_log | default('/var/log/apache2/access.log') }}
    pipeline_stages:
      - regex:
          expression: '^(?P<client_ip>[^ ]+) [^ ]+ [^ ]+ \[(?P<ts>[^\]]+)\] "(?P<method>\S+) (?P<path>[^"]*?) (?P<proto>\S+)" (?P<status>\d{3}) (?P<bytes>(?:\d+|-)) "(?P<referrer>[^"]*)" "(?P<user_agent>[^"]*)"(?: (?P<req_time_us>\d+))?'
      - timestamp:
          source: ts
          format: '02/Jan/2006:15:04:05 -0700'
      - labels:
          client_ip:
          method:
          path:
          status:
      - convert:
          status: { type: int }
          bytes:  { type: int }
          req_time_us: { type: int }

  - job_name: apache_error
    static_configs:
      - targets: [ "localhost" ]
        labels:
          job: apache_error
          app: {{ promtail_common_labels.app | default('webapp') | to_json }}
          env: {{ promtail_common_labels.env | default('prod') | to_json }}
          __path__: {{ apache_error_log | default('/var/log/apache2/error.log') }}
    pipeline_stages:
      - regex:
          expression: '^\[(?P<ts>[^\]]+)\] \[(?P<module>[^\]]+)\] \[(?P<pidtid>[^\]]+)\](?: \[client (?P<client>[^\]]+)\])? (?P<msg>.*)$'
      - timestamp:
          source: ts
          format: 'Mon Jan _2 15:04:05 2006'
      - labels:
        module:
        client:

